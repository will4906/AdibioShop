<!DOCTYPE html>
<!--
  ~ Copyright (c) 2017. willshuhua.
  -->

<html xmlns:th="http://www.thymeleaf.org" style="height: 100%">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<link rel="stylesheet" type="text/css" data-th-href="@{/jquery-weui/css/jquery-weui.css}"/>
	<link rel="stylesheet" type="text/css" data-th-href="@{/jquery-weui/css/weui.min.css}">
	<link rel="stylesheet" type="text/css" data-th-href="@{/AUI/css/aui.css}" />

	<!--<link rel="stylesheet" type="text/css" href="../../jquery-weui/css/jquery-weui.css"/>-->
	<!--<link rel="stylesheet" type="text/css" href="https://res.wx.qq.com/open/libs/weui/1.1.2/weui.min.css"/>-->
	<!--<link rel="stylesheet" type="text/css" href="../../AUI/css/aui.css" />-->


	<title>我的订单</title>
	
</head>
<body>
	<div class="weui-tab" id='page-infinite-navbar'>
		<div class="weui-navbar" style="position: fixed;top: 0;">
			<a href='#tab1' class="weui-navbar__item weui-bar__item--on" id="tabAll">
				全部
			</a>
			<a href='#tab2' class="weui-navbar__item" id="tabPaying">
				待付款
			</a>
			<a href='#tab3' class="weui-navbar__item" id="tabHanding">
				处理中
			</a>
			<a href='#tab4' class="weui-navbar__item" id="tabDone">
				已完成
			</a>
			<a href='#tab5' class="weui-navbar__item" id="tabCancel">
				已取消
			</a>
		</div>
		<div class="weui-tab__bd" style="width: 100%;">
			<div id="tab1" class="weui-tab__bd-item weui-tab__bd-item--active">
				<h1 class="doc-head"></h1>
				<!--*******all list********-->
				<div class="content-padded aui-content-padded"  id="allList"  style="margin-top: 0.8rem; height: 700px">
					<!--all item-->
					
					<!--all item-->
				</div>
			</div>
			<div id="tab2" class="weui-tab__bd-item">
				<h1 class="doc-head"></h1>
				<!--******paying list*******-->
				<div class="content-padded aui-content-padded" id="payingList"  style="height: 800px">
					<!--paying item-->
					
					<!--paying item-->
				</div>
			</div>
			<div id="tab3" class="weui-tab__bd-item" >
				<h1 class="doc-head"></h1>
				<!--**********handing list**********-->
				<div class="content-padded aui-content-padded" id="handingList" style="height: 800px">
					<!--handing item-->
					
					<!--hanfing item-->
				</div>
			</div>
			<div id="tab4" class="weui-tab__bd-item" >
				<h1 class="doc-head"></h1>
				<!--***********done list**************-->
				<div class="content-padded aui-content-padded" id="doneList" style="height: 800px">
					<!--done item-->

					<!--done item-->
				</div>
			</div>
			<div id="tab5" class="weui-tab__bd-item" >
				<h1 class="doc-head"></h1>
				<!--*************cancel list**********-->
				<div class="content-padded aui-content-padded" id="cancelList" style="height: 800px">
					<!--cancel item-->

					<!--cancel item-->
				</div>
				
			</div>
			<div class="weui-loadmore" id='loadMore'>
				<i class="weui-loading"></i>
				<span class="weui-loadmore__tips">正在加载</span>
			</div>
		</div>
	</div>


	<!--item temple-->
	<section id='templet' style="display: none;">
		<!--all-->
		<div id="all_templet">
			<div class="aui-card-list" name='allItem'>
				<input type="hidden" name="orderData">
				<div class="aui-card-list-header order-status_done"><span name="status">已完成</span></div>
				<div class="aui-card-list-content-padded">
					<div class="aui-row aui-row-padded">
						<div class="aui-col-xs-8" style="display: flex;flex-direction: column;" name='productList'>
							<span class="font-gray" name="productName">肾病早期筛查</span>
							
						</div>
						<div class="aui-col-xs-4">
							<div class=" aui-pull-right font-gray">金额:￥<span name="money">50</span></div>
						</div>
					</div>
				</div>
				<div class="aui-card-list-footer">
					<div class=" aui-pull-left">下单时间：<span name="time">2017-08-24 15:30:10</span></div>
					
				</div>
			</div>
		</div>
		<!--paying-->
		<div id="paying_templet">
			<div class="aui-card-list" name="payingItem">
				<input type="hidden" name="orderData">
				<div class="aui-card-list-header order-status_done"><span name="status">已完成</span></div>
				<div class="aui-card-list-content-padded">
					<div class="aui-row aui-row-padded">
						<div class="aui-col-xs-8" style="display: flex;flex-direction: column;" name='productList'>
							<span class="font-gray" name="productName">肾病早期筛查</span>
							
						</div>
						<div class="aui-col-xs-4"  style="display: flex;flex-direction: column;align-items: flex-end;">
							<div class=" aui-pull-right font-gray">金额:￥<span name="money">50</span></div>
							<!-- <div class="weui-btn weui-btn_mini weui-btn_primary" name="pay" style="margin: 0 0;">支付</div> -->
						</div>
					</div>
				</div>
				<div class="aui-card-list-footer">
					<div class=" aui-pull-left">下单时间：<span name="time">2017-08-24 15:30:10</span></div>
					
				</div>
			</div>
		</div>
		<!--show no more-->
		<div id="noMore_templet">
			<div style = "display: flex;justify-content: center;align-items: center">
				<h2>目前没有订单</h2>
			</div>
		</div>
	</section>
	<script type="text/javascript" data-th-src="@{/jquery-weui/js/jquery-3.2.1.min.js}"></script>
	<script type="text/javascript" data-th-src="@{/jquery-weui/js/jquery-weui.min.js}"></script>

	<!--<script type="text/javascript" src="../../jquery-3.2.1/jquery-3.2.1.min.js"></script>-->
	<!--<script type="text/javascript" src="../../jquery-weui/js/jquery-weui.min.js"></script>-->


	<script type="text/javascript" th:inline="javascript">
    var context = /*[[${#httpServletRequest.getScheme() + "://" + #httpServletRequest.getServerName() + ":" + #httpServletRequest.getServerPort() + #httpServletRequest.getContextPath()}]]*/;
    var path = context + '/user_init_orders';
    var pathMore = context + '/load_more_orders';
    var passScrollPlace;
    var curScrollPlace;
    var row_all;
    var row_paying;
    var row_handing;
    var row_done;
    var row_cancel;
    var loading = false;  //状态标记

	
	$(document).ready(function(){
		
		$('div.content-padded').height($(document).height()*0.7);
		
		Init();

       
	});

	
	//设置上拉刷新
	function PullUp(){
		var curID;
        $('#loadMore').css('display','block');
		$(document.body).infinite(0).on('infinite',function(){
			curID = $('div.weui-tab__bd-item--active').attr('id');
			passScrollPlace = $(document.body).scrollTop();
			if (curID=='tab1') {	
				LoadAll();
			}else if(curID=='tab2'){
				LoadPaying();
			}else if(curID=='tab3'){
				LoadHanding();
			}else if(curID=='tab4'){
				//LoadDone();
			}else{
				LoadCancel();
			}

		});
	}
	//倒计时计时器
	function setTimer(time,statusNode,listNode){
		if (time == 0) {
			listNode.remove();

			return 0;
		}else{
			statusNode.text('支付剩余时间：'+Math.floor(time/60)+':'+((time%60<10?('0'):'')+time%60));
			setTimeout(function () {
                setTimer(time-1,statusNode,listNode);
            },1000);
		}
	}
	//判断滚动条位置，初始条件passScrollPlace已经取值
	function ScrollPlace() {
        curScrollPlace = $(document.body).scrollTop();
        if (curScrollPlace==passScrollPlace) {
            $(document.body).off('infinite');
            $('#loadMore').css('display','none');
        }else{
            $(document.body).scrollTop(passScrollPlace);
        }
    }
	//初始化tab点击事件
	function Init(){
        $('#tabAll').click(function(e){
        	PullUp();
        	InitGetAll();
            $(document.body).scrollTop(0);
        });
        $('#tabAll').click();
        $('#tabPaying').click(function(e){
        	PullUp();
        	InitGetPaying();
            $(document.body).scrollTop(0);
        });
        $('#tabHanding').click(function(e){
        	PullUp();
        	InitGetHanding();
            $(document.body).scrollTop(0);
        });
        $('#tabDone').click(function(e){
//        	PullUp();
//        	InitGetDone();
//            $(document.body).scrollTop(0);
			ShowNoMore();
        });
        $('#tabCancel').click(function(e){
        	PullUp();
        	InitGetCancel();
            $(document.body).scrollTop(0);
        });

       
	}


	function GetDetail(clickObj){
        var orderData=clickObj.find('input:hidden').data();
	    var pathDetail = context + '/order_detail_page'+ '?order_id='+orderData.order_id;
        window.location.href = pathDetail;
    }
    //绑定打开订单详情事件
    function BindDetailEve(){
    	$('div[name=allItem]').off('click');
        $('div[name=allItem]').click(function(e){
            GetDetail($(this));
            e.stopPropagation();
        });
        $('div[name=payingItem]').off('click');
        $('div[name=payingItem]').click(function(e){
            GetDetail($(this));
            e.stopPropagation();
        });
    }
    //显示暂时无订单
	function ShowNoMore() {
        var curID;
        var list;
        $(document.body).off('infinite');
        $('#loadMore').css('display','none');
		curID = $('div.weui-tab__bd-item--active').attr('id');
		if (curID=='tab1') {
			list = $('#allList');
		}else if(curID=='tab2'){
            list = $('#payingList');
		}else if(curID=='tab3'){
            list = $('#handingList');
		}else if(curID=='tab4'){
            list = $('#doneList');
		}else{
            list = $('#cancelList');
		}
		list.append($('#noMore_templet').clone());


    }

	//绑定数据
	function BindData(bindObj,data) {
		bindObj.data(data);
    }
    //首次获得所有订单信息
    function InitGetAll(){
    	$('#allList').empty();
   
    	
        $.ajax({
            cache: true,
            type: "GET",
            url: path +'?type=ALL',
            async: true,
            error: function (request) {
                alert("Connection error");

            },
            success: function (data) {
                if(data.result=='ok' && data.parm == ''){
                    ShowNoMore();
                }else if(data.result=='ok' && data.parm != ''){
                    DrawAllList(data);
				}else{
                    alert('获取订单信息错误！');
				}
            }
        });  
    }
	//获取所有订单信息
	function GetAll() {
        $.ajax({
            cache: true,
            type: "GET",
            url: pathMore+'?type=ALL&row_id=' + row_all,
            async: true,
            error: function (request) {
				
                alert("Connection error");
                loading = false;
            },
            success: function (data) {
                if(data.result=='ok'){
                    DrawAllList(data);
                    ScrollPlace();
                }else{
					
                    alert('获取订单信息错误！');
				}
				loading = false;
				
            }
        });
    }
    //画出全部订单列表
	function DrawAllList(orderData) {
		$('#all_templet').find('div[name=productList]').html('<span class="font-gray" name="productName"></span>');
		var status;
        var allItem;
		var product = $('#all_templet').find('span[name=productName]');
		for(var i=0;  i<orderData.parm.length; i++){
			$('#all_templet').find('span[name=time]').text(orderData.parm[i].create_time);
			switch(orderData.parm[i].status){
				case "PAID":
				status = '已支付';
				break;
				case "CANCELED":
				status = '已取消';
				break;
                case 'RE_CREATION':
				case "CREATION":
				status = '未支付';
				break;
			}
			$('#all_templet').find('span[name=status]').text(status);
			$('#all_templet').find('span[name=money]').text(orderData.parm[i].price);

			$('#all_templet').find('div[name=productList]').empty();
			for (var j=0; j < orderData.parm[i].orderPreviewList.length; j++) {
				$('#all_templet').find('div[name=productList]').append(product.text(orderData.parm[i].orderPreviewList[j].product_name+' x'+orderData.parm[i].orderPreviewList[j].quantity).clone());
			}

			allItem = $('#all_templet').find('div[name=allItem]').clone();
			$('#allList').append(allItem);
			BindData($('#allList').find('input:hidden').last(),orderData.parm[i]);
			if (i==orderData.parm.length-1) {
				row_all = orderData.parm[i].row_id;
			}
			
		}
		BindDetailEve();
    }
    //首次获取待付款订单信息
    function InitGetPaying(){
    	$('#payingList').empty();
        $.ajax({
            cache: true,
            type: "GET",
            url: path+"?type=UNPAID",
            async: true,
            error: function (request) {
                alert("Connection error");

            },
            success: function (data) {
                if(data.result=='ok' && data.parm == ''){
                    ShowNoMore();
                }else if(data.result=='ok' && data.parm != ''){
                    DrawPayingList(data);
                }else{
                    alert('获取订单信息错误！');
                }
            }
        });


    }
    //获取待付款订单信息
	function GetPaying() {
        $.ajax({
            cache: true,
            type: "GET",
            url: pathMore + '?type=UNPAID&row_id='+row_paying,
            async: true,
            error: function (request) {
                alert("Connection error");
                loading = false;
            },
            success: function (data) {
                if(data.result=='ok'){
                    DrawPayingList(data);
                    ScrollPlace();
                }else{
                	
                    alert('获取订单信息错误！');
                }
                loading = false;
            }
        });
    }
    //画出待付款订单列表
	function DrawPayingList(orderData) {
        var seconds
        var payingItem
		$('#paying_templet').find('div[name=productList]').html('<span class="font-gray" name="productName"></span>');
		var status = "待支付";
		var product = $('#paying_templet').find('span[name=productName]');
		for(var i=0; i<orderData.parm.length ;i++){

			seconds  = GetSeconds(orderData.parm[i].create_time);
			$('#paying_templet').find('span[name=time]').text(orderData.parm[i].create_time);
			$('#paying_templet').find('span[name=money]').text(orderData.parm[i].price);

			$('#paying_templet').find('div[name=productList]').empty();
			for (var j=0; j < orderData.parm[i].orderPreviewList.length; j++) {
				$('#paying_templet').find('div[name=productList]').append(product.text(orderData.parm[i].orderPreviewList[j].product_name+' x'+orderData.parm[i].orderPreviewList[j].quantity).clone())
			}
			payingItem = $('#paying_templet').find('div[name=payingItem]').clone();
			$('#payingList').append(payingItem);
			BindData($('#payingList').find('input:hidden').last(),orderData.parm[i]);
			
			setTimer(15*60-seconds,$('#payingList').find('span[name=status]').last(),$('#payingList').find('div[name=payingItem]').last()); //计时器
			if (i==orderData.parm.length-1) {
				row_paying = orderData.parm[i].row_id;
			}
			
		}
		BindDetailEve();
    }

    //首次获取处理中订单信息
    function InitGetHanding(){
    	$('#handingList').empty();
    	
        $.ajax({
            cache: true,
            type: "GET",
            url: path +'?type=PROCESSING',
            async: true,
            error: function (request) {
                alert("Connection error");

            },
            success: function (data) {
                if(data.result=='ok' && data.parm == ''){
                    ShowNoMore();
                }else if(data.result=='ok' && data.parm != ''){
                    DrawHandingList(data);
                }else{
                    alert('获取订单信息错误！');
                }
            }
        });


    }
    //获取处理中订单信息
    function GetHanding() {
    	
        $.ajax({
            cache: true,
            type: "GET",
            url: path + '?type=PROCESSING&row_id='+row_handing,
            async: true,
            error: function (request) {
                alert("Connection error");
                loading = false;
            },
            success: function (data) {
                
                if(data.result=='ok'){
                    DrawHandingList(data);
                    ScrollPlace();
                    
                }else{
                    
                    alert('获取订单信息错误！');
                }
                loading = false;
            }
        });
    }
    //画出处理中订单列表
    function DrawHandingList(orderData) {
    	$('#all_templet').find('div[name=productList]').html('<span class="font-gray" name="productName"></span>');
		var status = "处理中";
        var handingItem;
		var product = $('#all_templet').find('span[name=productName]');
		for(var i=0; i<orderData.parm.length ;i++){
			$('#all_templet').find('span[name=time]').text(orderData.parm[i].create_time);
			switch(orderData.parm[i].status){
				case "PAID":
				status = '已支付';
				break;
				// case "CANCELED":
				// status = '已取消';
				// break;
				// case "CREATION":
				// status = '已完成';
				// break;
			}
			$('#all_templet').find('span[name=status]').text(status);
			$('#all_templet').find('span[name=money]').text(orderData.parm[i].price);

			$('#all_templet').find('div[name=productList]').empty();
			for (var j=0; j < orderData.parm[i].orderPreviewList.length; j++) {
				$('#all_templet').find('div[name=productList]').append(product.text(orderData.parm[i].orderPreviewList[j].product_name+' x'+orderData.parm[i].orderPreviewList[j].quantity).clone())
			}
			handingItem = $('#all_templet').find('div[name=allItem]').clone();
			$('#handingList').append(handingItem);
			BindData($('#handingList').find('input:hidden').last(),orderData.parm[i]);
			if (i==orderData.parm.length-1) {
				row_handing = orderData.parm[i].row_id;
			}
			
		}
		BindDetailEve();
    }
    //首次获取已完成订单信息
    function InitGetDone(){
    	$('#doneList').empty();
    	
        $.ajax({
            cache: true,
            type: "GET",
            url: path + '?type=FINISHED',
            async: true,
            error: function (request) {
                alert("Connection error");
            },
            success: function (data) {
                if(data.result=='ok' && data.parm == ''){
                    ShowNoMore();
                }else if(data.result=='ok' && data.parm != ''){
                    DrawDoneList(data);        
                }else{
                    alert('获取订单信息错误！');
                }
            }
        });
   
	}

    //获取已完成订单信息
    function GetDone() {
    	
        $.ajax({
            cache: true,
            type: "GET",
            url: pathMore + '?type=FINISHED&row_id='+row_done,
            async: true,
            error: function (request) {
                alert("Connection error");
                loading = false;
            },
            success: function (data) {
                if(data.result=='ok'){
                    DrawDoneList(data);
                    ScrollPlace();
                }else{
                	
                    alert('获取订单信息错误！');
                }
                loading = false;
            }
        });
    }
    //画出已完成订单列表
    function DrawDoneList(orderData) {
    	$('#all_templet').find('div[name=productList]').html('<span class="font-gray" name="productName"></span>');
		var status = "已完成";
        var doneItem;
		var product = $('#all_templet').find('span[name=productName]');
		for(var i=0; i<orderData.parm.length ;i++){
			$('#all_templet').find('span[name=time]').text(orderData.parm[i].create_time);
			$('#all_templet').find('span[name=status]').text(status);
			$('#all_templet').find('span[name=money]').text(orderData.parm[i].price);

			$('#all_templet').find('div[name=productList]').empty();
			for (var j=0; j < orderData.parm[i].orderPreviewList.length; j++) {
				$('#all_templet').find('div[name=productList]').append(product.text(orderData.parm[i].orderPreviewList[j].product_name+' x'+orderData.parm[i].orderPreviewList[j].quantity).clone());
			}
			doneItem = $('#all_templet').find('div[name=allItem]').clone();
			$('#doneList').append(doneItem);
			BindData($('#doneList').find('input:hidden').last(),orderData.parm[i]);
			if (i==orderData.parm.length-1) {
				row_done = orderData.parm[i].row_id;
			}
			
		}
		BindDetailEve();
    }
    //首次获得已取消订单信息
    function InitGetCancel(){
    	$('#cancelList').empty();
   
        $.ajax({
            cache: true,
            type: "GET",
            url: path +  '?type=CANCELED',
            async: true,
            error: function (request) {
                alert("Connection error");
            },
            success: function (data) {
                if(data.result=='ok' && data.parm == ''){
                    ShowNoMore();
                }else if(data.result=='ok' && data.parm != ''){
                    DrawCancelList(data);
                }else{
                    alert('获取订单信息错误！');
                }
            }
        });

    }
    //获取已取消订单信息
    function GetCancel(cancelReq) {
        $.ajax({
            cache: true,
            type: "GET",
            url: pathMore + '?type=CANCELED&row_id='+row_cancel,
            async: true,
            error: function (request) {
                alert("Connection error");
                loading = false;
            },
            success: function (data) {
                if(data.result=='ok'){
                    DrawCancelList(data);
                    ScrollPlace();
                }else{
                    alert('获取订单信息错误！');
                }
                loading = false;
            }
        });
    }
    //画出已取消订单列表
    function DrawCancelList(orderData) {
    	$('#all_templet').find('div[name=productList]').html('<span class="font-gray" name="productName"></span>');
		var status = "已取消";
        var cancelItem;
		var product = $('#all_templet').find('span[name=productName]');
		for(var i=0; i<orderData.parm.length ;i++){
			$('#all_templet').find('span[name=time]').text(orderData.parm[i].create_time);
			$('#all_templet').find('span[name=status]').text(status);
			$('#all_templet').find('span[name=money]').text(orderData.parm[i].price);

			$('#all_templet').find('div[name=productList]').empty();
			for (var j=0; j < orderData.parm[i].orderPreviewList.length; j++) {
				$('#all_templet').find('div[name=productList]').append(product.text(orderData.parm[i].orderPreviewList[j].product_name+' x'+orderData.parm[i].orderPreviewList[j].quantity).clone());
			}
			cancelItem = $('#all_templet').find('div[name=allItem]').clone();
			$('#cancelList').append(cancelItem);
			BindData($('#cancelList').find('input:hidden').last(),orderData.parm[i]);
			if (i==orderData.parm.length-1) {
				row_cancel = orderData.parm[i].row_id;
			}
		}
		BindDetailEve();
    }

    //全部订单额面加载更多
    function LoadAll(){
    	if(loading) return;
    	if(row_all>0){
            GetAll();
		}
    }
    //待支付订单额面加载更多
    function LoadPaying(){
    	if(loading) return;
    	if(row_paying>0){
            GetPaying();
		}
    }
    //处理中订单额面加载更多
    function LoadHanding(){
    	if(loading) return;
    	if(row_handing>0){
            GetHanding();
		}
    }
    //已完成订单额面加载更多
    function LoadDone(){
    	if(loading) return;
    	if(row_done>0){
            GetDone();
		}

    }
    //已取消订单额面加载更多
    function LoadCancel(){
    	if(loading) return;
    	if(row_cancel){
            GetCancel();
		}
    }

    //转化返回的date数据
    	/*dateObj {
    		year,
    		month,
    		day,
    		times
    	}*/
    function GetSeconds(dateStr){
    	var nowDate =new Date();
    	var orderDate = new Date(dateStr);
    	var seconds = Math.floor((nowDate.getTime()-orderDate.getTime())/1000);
    	return seconds;
    }

	//下拉刷新

	/*var pullRefresh = new auiPullToRefresh({
	    container: document.querySelector('.aui-refresh-content'),//下拉容器
	    textDown:"刷新",
	    triggerDistance: 100 //下拉高度
	},function(ret){
	    if(ret.status=="success"){
	           //请求服务器数据
	           if (tabIndex==1) {
	           	console.log("all");
	           	//获取已完成的订单数据
	           }else if(tabIndex==2){
	           	console.log("paying");
	           	//获取待付款的订单数据
	           }
	           pullRefresh.cancelLoading();//刷新成功后调用此方法隐藏
	        }
	    
	})*/

</script>
<style type="text/css">
	.order-status_done,.order-status_paying{
		color:#299238;
		display: flex;
		justify-content: flex-end;
	}
	.font-gray{
		color: #888;
	}

	.weui-toast{
		margin-left: :0; 
	}
</style>
</body>


</html>

